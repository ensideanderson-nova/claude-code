<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—„ï¸ ENSIDE DATABASE v6.15 - Sistema Ultra Completo + Google Sheets</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#1a5f2a;--secondary:#2e8b3e;--success:#28a745;--danger:#dc3545;--warning:#ffc107;--whatsapp:#25D366;--dark:#2c3e50}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);min-height:100vh;padding:12px}
        .container{max-width:1600px;margin:0 auto}
        .panel{background:white;border-radius:15px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2);margin-bottom:12px}
        .header{text-align:center;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .header h1{color:var(--primary);font-size:1.8em}
        .header .whatsapp-vinculado{display:inline-flex;align-items:center;gap:8px;color:white;font-weight:bold;margin-top:10px;padding:8px 20px;background:linear-gradient(135deg,var(--whatsapp),#128C7E);border-radius:20px;cursor:pointer}
        .header .status{display:inline-flex;align-items:center;gap:8px;color:var(--success);font-weight:bold;margin-top:10px;padding:8px 20px;background:#d4edda;border-radius:20px;margin-left:10px}
        .header .pulse{width:10px;height:10px;background:var(--success);border-radius:50%;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.3)}}
        .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
        .tab-btn{padding:10px 14px;background:#f5f5f5;border:none;cursor:pointer;font-weight:600;color:#666;border-radius:8px;transition:all 0.3s;display:flex;align-items:center;gap:6px;font-size:0.9em}
        .tab-btn:hover{background:#e8e8e8}
        .tab-btn.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white}
        .tab-btn .badge{background:rgba(255,255,255,0.3);padding:2px 8px;border-radius:10px;font-size:0.8em}
        .tab-content{display:none}.tab-content.active{display:block}
        .section-title{color:var(--primary);font-size:1.2em;margin-bottom:15px;font-weight:600;border-bottom:2px solid #f0f0f0;padding-bottom:10px}
        .upload-area{border:3px dashed var(--primary);border-radius:12px;padding:30px;text-align:center;cursor:pointer;background:#f9f9f9;transition:all 0.3s}
        .upload-area:hover{background:#f0f0ff;border-color:var(--secondary)}
        input[type="file"]{display:none}
        .alert{padding:15px;border-radius:10px;margin:12px 0;border-left:4px solid}
        .alert.success{background:#d4edda;border-left-color:var(--success);color:#155724}
        .alert.error{background:#f8d7da;border-left-color:var(--danger);color:#721c24}
        .alert.info{background:#d1ecf1;border-left-color:#17a2b8;color:#0c5460}
        .alert.warning{background:#fff3cd;border-left-color:var(--warning);color:#856404}
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin:15px 0}
        .stat{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:15px;border-radius:12px;text-align:center;transition:transform 0.3s}
        .stat:hover{transform:translateY(-3px)}
        .stat.success{background:linear-gradient(135deg,var(--success),#20c997)}
        .stat.warning{background:linear-gradient(135deg,var(--warning),#fd7e14)}
        .stat.whatsapp{background:linear-gradient(135deg,var(--whatsapp),#128C7E)}
        .stat.danger{background:linear-gradient(135deg,var(--danger),#c82333)}
        .stat-number{font-size:1.8em;font-weight:bold}
        .stat-label{font-size:0.8em;opacity:0.9}
        .search-box input{width:100%;padding:12px 12px 12px 40px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 12px center;background-size:18px;margin-bottom:12px}
        .search-box input:focus{outline:none;border-color:var(--primary)}
        .card{background:#f9f9f9;padding:15px;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--primary);transition:all 0.3s}
        .card:hover{transform:translateX(5px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:5px}
        .card-title{font-weight:600;color:#333}
        .card-badge{padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600}
        .badge-motorista{background:#e8f5e9;color:#388e3c}
        .badge-fornecedor{background:#fff3e0;color:#f57c00}
        .badge-cliente{background:#e3f2fd;color:#1976d2}
        .badge-regiao{background:#f3e5f5;color:#7b1fa2}
        .card-field{color:#666;font-size:0.9em;margin:4px 0}
        .card-field a{color:var(--whatsapp);text-decoration:none;font-weight:600}
        table{width:100%;border-collapse:collapse;margin-top:12px;font-size:0.85em}
        thead{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white}
        th,td{padding:8px 10px;text-align:left}
        tbody tr{border-bottom:1px solid #eee}
        tbody tr:hover{background:#f9f9f9}
        button{padding:10px 16px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin:5px 5px 5px 0;transition:all 0.3s;font-size:0.9em}
        button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
        .btn-full{width:100%;margin:8px 0;padding:14px}
        .btn-success{background:linear-gradient(135deg,var(--success),#20c997)}
        .btn-danger{background:linear-gradient(135deg,var(--danger),#c82333)}
        .btn-whatsapp{background:linear-gradient(135deg,var(--whatsapp),#128C7E)}
        .btn-warning{background:linear-gradient(135deg,var(--warning),#fd7e14);color:#333}
        .btn-small{padding:6px 12px;font-size:0.85em}
        .form-group{margin-bottom:12px}
        .form-group label{display:block;margin-bottom:5px;font-weight:600;color:#333;font-size:0.9em}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
        .form-section{background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:15px;border-left:4px solid var(--primary)}
        .form-section h4{color:var(--primary);margin-bottom:12px}
        .checkbox-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
        .checkbox-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;border:1px solid #e0e0e0;cursor:pointer}
        .checkbox-item:hover{background:#f0f0f0}
        .checkbox-item input[type="checkbox"]{width:18px;height:18px}
        .chat-box{border:2px solid var(--whatsapp);border-radius:12px;overflow:hidden;margin-top:15px}
        .chat-header{background:linear-gradient(135deg,var(--whatsapp),#128C7E);color:white;padding:12px 15px;display:flex;justify-content:space-between;align-items:center}
        .chat-messages{height:400px;overflow-y:auto;padding:15px;background:#e5ddd5}
        .chat-msg{margin:10px 0;padding:12px 15px;border-radius:12px;max-width:85%;line-height:1.5}
        .chat-msg.user{background:#dcf8c6;margin-left:auto;border-bottom-right-radius:4px}
        .chat-msg.agent{background:white;border:1px solid #e0e0e0;border-bottom-left-radius:4px}
        .chat-msg .time{font-size:0.7em;opacity:0.7;margin-top:5px;text-align:right}
        .chat-input{display:flex;border-top:2px solid var(--whatsapp)}
        .chat-input input{flex:1;padding:14px;border:none;font-size:1em}
        .chat-input button{border-radius:0;margin:0}
        .list-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f9f9f9;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--primary)}
        .list-item:hover{background:#f0f0f0}
        .list-info h4{color:#333;margin-bottom:5px}
        .list-info p{color:#666;font-size:0.85em}
        .list-count{background:var(--primary);color:white;padding:5px 15px;border-radius:20px;font-weight:600}
        .progress-bar{height:12px;background:#e0e0e0;border-radius:6px;overflow:hidden;margin:8px 0}
        .progress-fill{height:100%;background:linear-gradient(135deg,var(--primary),var(--secondary));transition:width 0.5s}
        .knowledge-card{background:linear-gradient(135deg,#f5f7fa,#e8ecf1);padding:15px;border-radius:12px;margin-bottom:12px;border-left:4px solid var(--primary)}
        .knowledge-card h4{color:var(--primary);margin-bottom:8px}
        .knowledge-card p{color:#666;line-height:1.5;font-size:0.95em}
        .knowledge-card .categoria{display:inline-block;background:var(--primary);color:white;padding:2px 10px;border-radius:10px;font-size:0.75em;margin-bottom:8px}
        .knowledge-tags{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
        .knowledge-tag{background:#e3f2fd;color:#1976d2;padding:3px 10px;border-radius:12px;font-size:0.8em}
        .inner-tabs{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
        .inner-tab{padding:8px 14px;background:#f0f0f0;border:none;cursor:pointer;color:#666;font-weight:600;border-radius:6px;font-size:0.9em}
        .inner-tab:hover{background:#e0e0e0}
        .inner-tab.active{background:var(--primary);color:white}
        .inner-content{display:none}.inner-content.active{display:block}
        .versao-badge{background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;padding:5px 15px;border-radius:15px;font-weight:bold;font-size:0.85em}
        .motorista-card{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-left-color:#388e3c}
        .wa-conversation{background:#fff;border-radius:10px;padding:15px;margin-bottom:10px;border:1px solid #e0e0e0}
        .wa-conversation .header{display:flex;justify-content:space-between;margin-bottom:10px}
        .wa-conversation .contato{font-weight:bold;color:var(--whatsapp)}
        .wa-conversation .hora{color:#999;font-size:0.85em}
        .wa-conversation .msg{background:#e5ddd5;padding:10px;border-radius:8px}
        .config-whatsapp{background:linear-gradient(135deg,#d4edda,#c3e6cb);padding:20px;border-radius:12px;border:2px solid var(--whatsapp);margin-bottom:20px}
        .config-whatsapp h3{color:#155724;margin-bottom:15px}
        @media(max-width:768px){.form-row{grid-template-columns:1fr}.dashboard{grid-template-columns:repeat(2,1fr)}.tabs{justify-content:center}}
    </style>
</head>
<body>
<div class="container">
    <div class="panel">
        <div class="header">
            <h1>ğŸ—„ï¸ ENSIDE DATABASE v6.15</h1>
            <p><strong>Enside Madeiras</strong> - Anderson Enside | Sistema Ultra Completo + Triagem IA + Google Sheets</p>
            <div style="margin-top:10px;">
                <div class="whatsapp-vinculado" onclick="abrirAba('whatsapp',document.querySelector('[onclick*=whatsapp]'))">ğŸ“± <span id="waVinculadoHeader">(18) 99654-0492</span></div>
                <div class="status"><div class="pulse"></div><span>ğŸ§  Agente NÃ­vel <span id="headerNivel">1</span></span></div>
                <span class="versao-badge" style="margin-left:10px;">v6.15 ULTRA</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="abrirAba('inicio',this)">ğŸ  InÃ­cio</button>
            <button class="tab-btn" onclick="abrirAba('motoristas',this)">ğŸšš Motoristas <span class="badge" id="badgeMot">0</span></button>
            <button class="tab-btn" onclick="abrirAba('cadastrar',this)">â• Cadastrar</button>
            <button class="tab-btn" onclick="abrirAba('importar',this)">ğŸ“¤ Importar</button>
            <button class="tab-btn" onclick="abrirAba('listas',this)">ğŸ“‹ Listas</button>
            <button class="tab-btn" onclick="abrirAba('agente',this)">ğŸ§  Agente IA</button>
            <button class="tab-btn" onclick="abrirAba('whatsapp',this)">ğŸ“± WhatsApp</button>
            <button class="tab-btn" onclick="abrirAba('aprendizado',this)">ğŸ“š Conhecimentos <span class="badge" id="badgeConh">0</span></button>
            <button class="tab-btn" onclick="abrirAba('exportar',this)">ğŸ’¾ Exportar</button>
            <button class="tab-btn" onclick="abrirAba('sheets',this)">ğŸ“Š Google Sheets</button>
        </div>
    </div>

    <!-- INÃCIO -->
    <div id="inicio" class="tab-content active">
        <div class="panel">
            <div class="section-title">ğŸ  Dashboard - Sistema de Fretes Profissional</div>

            <div id="alertaMigracao" class="alert success" style="display:none;">
                âœ… <strong>Dados migrados!</strong> Seus conhecimentos e contatos foram preservados da versÃ£o anterior.
            </div>

            <div class="dashboard">
                <div class="stat"><div class="stat-number" id="sTotal">0</div><div class="stat-label">Total Registros</div></div>
                <div class="stat success"><div class="stat-number" id="sMot">0</div><div class="stat-label">ğŸšš Motoristas</div></div>
                <div class="stat warning"><div class="stat-number" id="sFor">0</div><div class="stat-label">ğŸ“¦ Fornecedores</div></div>
                <div class="stat"><div class="stat-number" id="sCli">0</div><div class="stat-label">ğŸ‘¥ Clientes</div></div>
                <div class="stat whatsapp"><div class="stat-number" id="sWa">0</div><div class="stat-label">ğŸ“± WhatsApp</div></div>
                <div class="stat danger"><div class="stat-number" id="sConh">0</div><div class="stat-label">ğŸ“š Conhecimentos</div></div>
            </div>

            <div style="margin:20px 0;padding:20px;background:linear-gradient(135deg,rgba(26,95,42,0.1),rgba(46,139,62,0.1));border-radius:12px;border:2px solid var(--primary);">
                <h4 style="color:var(--primary);margin-bottom:15px;">ğŸ§  Status do Agente IA</h4>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;">
                    <div><strong>NÃ­vel:</strong> <span id="dashNivel">1</span></div>
                    <div><strong>XP:</strong> <span id="dashXP">0</span></div>
                    <div><strong>PrecisÃ£o:</strong> <span id="dashPrecisao">50%</span></div>
                    <div><strong>Conhecimentos:</strong> <span id="dashConh">0</span></div>
                    <div><strong>InteraÃ§Ãµes:</strong> <span id="dashInteracoes">0</span></div>
                    <div><strong>Conversas WA:</strong> <span id="dashConversas">0</span></div>
                </div>
                <div style="margin-top:15px;">
                    <p style="font-weight:600;color:#333;">Aprendizado:</p>
                    <div class="progress-bar"><div class="progress-fill" id="dashProgress" style="width:10%"></div></div>
                    <p style="color:#666;font-size:0.9em;" id="dashProgressText">10% - Iniciante</p>
                </div>
            </div>

            <table>
                <thead><tr><th>Categoria</th><th>Total</th><th>Com WhatsApp</th><th>Completos</th></tr></thead>
                <tbody id="tblAnalise"></tbody>
            </table>
        </div>
    </div>

    <!-- MOTORISTAS -->
    <div id="motoristas" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸšš Motoristas / Transportadores / Contatos</div>
            <div class="form-row" style="margin-bottom:15px;">
                <div class="search-box" style="flex:2;margin:0;"><input type="text" id="buscaMot" placeholder="Buscar..." oninput="filtrarMotoristas()"></div>
                <select id="filtroTipo" onchange="filtrarMotoristas()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="">Todos Tipos</option>
                    <option value="motoristas">ğŸšš Motoristas</option>
                    <option value="fornecedores">ğŸ“¦ Fornecedores</option>
                    <option value="clientes">ğŸ‘¥ Clientes</option>
                </select>
                <select id="filtroRegiao" onchange="filtrarMotoristas()" style="padding:10px;border:2px solid #e0e0e0;border-radius:8px;">
                    <option value="">Todas RegiÃµes</option>
                    <option value="SUL">Sul</option>
                    <option value="SUDESTE">Sudeste</option>
                    <option value="CENTRO-OESTE">Centro-Oeste</option>
                    <option value="NORDESTE">Nordeste</option>
                    <option value="NORTE">Norte</option>
                </select>
            </div>
            <div id="listaMot"></div>
        </div>
    </div>

    <!-- CADASTRAR -->
    <div id="cadastrar" class="tab-content">
        <div class="panel">
            <div class="section-title">â• Cadastro Completo (50 Campos)</div>

            <div class="form-section">
                <h4>ğŸ‘¤ Parte 1: Dados BÃ¡sicos</h4>
                <div class="form-row">
                    <div class="form-group"><label>Categoria *</label><select id="cadCategoria"><option value="motoristas">ğŸšš Motorista/Frete</option><option value="fornecedores">ğŸ“¦ Fornecedor</option><option value="clientes">ğŸ‘¥ Cliente</option></select></div>
                    <div class="form-group"><label>Nome Completo *</label><input type="text" id="cadNome" placeholder="Nome"></div>
                    <div class="form-group"><label>WhatsApp *</label><input type="text" id="cadWhatsapp" placeholder="(18) 99999-9999"></div>
                </div>
                <div class="form-group"><label>Rotas Preferidas (separe por vÃ­rgula)</label><input type="text" id="cadRotas" placeholder="SP-PR, SP-MG, SP-RJ..."></div>
            </div>

            <div class="form-section">
                <h4>ğŸš› Parte 2: VeÃ­culo</h4>
                <div class="form-row">
                    <div class="form-group"><label>Tipo Profissional</label><select id="cadTipoPro"><option value="">Selecione...</option><option value="autonomo">AutÃ´nomo</option><option value="agregado">Agregado</option><option value="frota">Frota</option><option value="empresa">Empresa</option></select></div>
                    <div class="form-group"><label>Tipo VeÃ­culo</label><select id="cadTipoVeiculo"><option value="">Selecione...</option><option value="truck">Truck</option><option value="carreta">Carreta</option><option value="bitrem">Bitrem</option><option value="rodotrem">Rodotrem</option><option value="toco">Toco</option><option value="vuc">VUC</option></select></div>
                    <div class="form-group"><label>Placa</label><input type="text" id="cadPlaca" placeholder="ABC-1234"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Capacidade (ton)</label><input type="number" id="cadCapacidade" placeholder="25"></div>
                    <div class="form-group"><label>Tipo Carroceria</label><select id="cadCarroceria"><option value="">Selecione...</option><option value="aberta">Aberta</option><option value="fechada">Fechada (BaÃº)</option><option value="sider">Sider</option><option value="graneleira">Graneleira</option></select></div>
                </div>
            </div>

            <div class="form-section">
                <h4>ğŸ—ºï¸ Parte 3: RegiÃµes de AtuaÃ§Ã£o</h4>
                <div class="checkbox-grid">
                    <label class="checkbox-item"><input type="checkbox" id="cadSul"> Sul</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadSudeste"> Sudeste</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadCentroOeste"> Centro-Oeste</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadNordeste"> Nordeste</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadNorte"> Norte</label>
                </div>
            </div>

            <div class="form-section">
                <h4>ğŸ“¦ Parte 4: Tipos de Carga</h4>
                <div class="checkbox-grid">
                    <label class="checkbox-item"><input type="checkbox" id="cadMadeira"> ğŸªµ Madeira</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadCompensados"> Compensados</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadMDF"> MDF</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadMoveis"> ğŸª‘ MÃ³veis</label>
                    <label class="checkbox-item"><input type="checkbox" id="cadGeral"> Geral</label>
                </div>
            </div>

            <div class="form-section">
                <h4>ğŸ’° Parte 5: Pagamento</h4>
                <div class="form-row">
                    <div class="form-group"><label>Forma Pagamento</label><select id="cadPagamento"><option value="">Selecione...</option><option value="pix">PIX</option><option value="deposito">DepÃ³sito</option><option value="boleto">Boleto</option></select></div>
                    <div class="form-group"><label>PIX</label><input type="text" id="cadPix" placeholder="CPF ou Telefone"></div>
                    <div class="form-group"><label>Banco</label><input type="text" id="cadBanco" placeholder="Banco"></div>
                </div>
            </div>

            <div class="form-section">
                <h4>ğŸ“„ Parte 6: Documentos</h4>
                <div class="form-row">
                    <div class="form-group"><label>CPF/CNPJ</label><input type="text" id="cadCpfCnpj" placeholder="000.000.000-00"></div>
                    <div class="form-group"><label>ANTT/RNTRC</label><input type="text" id="cadAntt" placeholder="000000000"></div>
                </div>
            </div>

            <button onclick="salvarContato()" class="btn-success btn-full">ğŸ’¾ Salvar</button>
            <div id="alertaCad"></div>
        </div>
    </div>

    <!-- IMPORTAR -->
    <div id="importar" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“¤ Importar Dados</div>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:2.5em;margin-bottom:10px">ğŸ“</div>
                <div style="color:var(--primary);font-weight:600;font-size:1.1em">Clique ou arraste arquivo</div>
                <div style="color:#999;margin-top:10px">CSV, Excel (.xlsx), JSON</div>
            </div>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json" onchange="importarArquivo(event)">
            <div id="alertaImport"></div>
            <div id="importPreview" style="display:none;margin-top:20px;">
                <div class="alert info">ğŸ“Š <span id="prevTotal">0</span> registros prontos</div>
                <button onclick="confirmarImportacao()" class="btn-success btn-full">âœ… Confirmar</button>
                <button onclick="cancelarImportacao()" class="btn-danger btn-full">âŒ Cancelar</button>
            </div>
        </div>
    </div>

    <!-- LISTAS -->
    <div id="listas" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“‹ Listas de TransmissÃ£o WhatsApp</div>
            <div class="alert info">ğŸ“± Limite: 256 contatos/lista</div>
            <div class="inner-tabs">
                <button class="inner-tab active" onclick="abrirInner('listaCriar',this)">â• Criar</button>
                <button class="inner-tab" onclick="abrirInner('listaGerenciar',this)">ğŸ“‹ Minhas Listas</button>
            </div>
            <div id="listaCriar" class="inner-content active">
                <div class="form-group"><label>Nome da Lista *</label><input type="text" id="listaNome" placeholder="Ex: Motoristas SP"></div>
                <div class="form-row">
                    <div class="form-group"><label>Tipo</label><select id="listaFiltroTipo"><option value="">Todos</option><option value="motoristas">ğŸšš Motoristas</option><option value="fornecedores">ğŸ“¦ Fornecedores</option><option value="clientes">ğŸ‘¥ Clientes</option></select></div>
                    <div class="form-group"><label>RegiÃ£o</label><select id="listaFiltroRegiao"><option value="">Todas</option><option value="SUL">Sul</option><option value="SUDESTE">Sudeste</option><option value="CENTRO-OESTE">Centro-Oeste</option><option value="NORDESTE">Nordeste</option><option value="NORTE">Norte</option></select></div>
                </div>
                <button onclick="criarLista()" class="btn-success btn-full">âœ… Criar Lista</button>
            </div>
            <div id="listaGerenciar" class="inner-content"><div id="minhasListas"></div></div>
        </div>
    </div>

    <!-- AGENTE IA -->
    <div id="agente" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ§  Agente IA - Usa Seus Conhecimentos!</div>
            <div class="dashboard">
                <div class="stat"><div class="stat-number" id="agNivel">1</div><div class="stat-label">NÃ­vel</div></div>
                <div class="stat success"><div class="stat-number" id="agXP">0</div><div class="stat-label">XP</div></div>
                <div class="stat warning"><div class="stat-number" id="agPrecisao">50%</div><div class="stat-label">PrecisÃ£o</div></div>
                <div class="stat whatsapp"><div class="stat-number" id="agConh">0</div><div class="stat-label">Conhecimentos</div></div>
            </div>

            <div class="chat-box">
                <div class="chat-header">
                    <span>ğŸ¤– Enside Agent v6.15 | ğŸ“± <span id="chatWaNum">(18) 99654-0492</span></span>
                    <span id="agTyping" style="display:none;font-size:0.9em;">digitando...</span>
                </div>
                <div class="chat-messages" id="chatMsgs"></div>
                <div class="chat-input">
                    <input type="text" id="chatIn" placeholder="Pergunte sobre fretes, motoristas, preÃ§os..." onkeypress="if(event.key==='Enter')enviarMsg()">
                    <button onclick="enviarMsg()" class="btn-whatsapp">Enviar</button>
                </div>
            </div>
            <div class="alert info" style="margin-top:15px;">ğŸ’¡ <strong>O agente busca nos seus conhecimentos!</strong> Adicione informaÃ§Ãµes na aba ğŸ“š Conhecimentos</div>
        </div>
    </div>

    <!-- WHATSAPP -->
    <div id="whatsapp" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“± WhatsApp - ConfiguraÃ§Ã£o e Conversas</div>

            <div class="config-whatsapp">
                <h3>ğŸ“± NÃºmero Vinculado</h3>
                <div class="form-row">
                    <div class="form-group"><label>Seu WhatsApp *</label><input type="text" id="waNumero" value="5518996540492" placeholder="5518999999999"></div>
                    <div class="form-group"><label>Nome</label><input type="text" id="waNome" value="Anderson Enside"></div>
                </div>
                <button onclick="salvarWhatsApp()" class="btn-whatsapp btn-full">ğŸ’¾ Salvar ConfiguraÃ§Ã£o</button>
            </div>

            <div class="dashboard" style="margin-top:20px;">
                <div class="stat whatsapp"><div class="stat-number" id="waConv">0</div><div class="stat-label">Conversas</div></div>
                <div class="stat success"><div class="stat-number" id="waMsgs">0</div><div class="stat-label">Mensagens</div></div>
                <div class="stat"><div class="stat-number" id="waAprend">0</div><div class="stat-label">Aprendizados</div></div>
            </div>

            <h4 style="margin:20px 0 15px;color:#333;">ğŸ“¬ Conversas Simuladas</h4>
            <div id="waConversas"></div>
            <button onclick="simularConversa()" class="btn-whatsapp btn-full" style="margin-top:15px;">â• Simular Conversa (teste)</button>
        </div>
    </div>

    <!-- CONHECIMENTOS / APRENDIZADO -->
    <div id="aprendizado" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“š Base de Conhecimento - Ensine o Agente!</div>
            <div class="alert success">ğŸ§  <strong>IMPORTANTE:</strong> Seus conhecimentos da versÃ£o anterior foram preservados! O agente usa essas informaÃ§Ãµes para responder.</div>

            <div class="form-group"><label>TÃ­tulo *</label><input type="text" id="conhTitulo" placeholder="Ex: PreÃ§o frete SP-PR"></div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="conhCat">
                    <option value="fretes">ğŸšš Fretes</option>
                    <option value="rotas">ğŸ—ºï¸ Rotas</option>
                    <option value="precos">ğŸ’° PreÃ§os</option>
                    <option value="produtos">ğŸªµ Produtos</option>
                    <option value="motoristas">ğŸ‘¤ Motoristas</option>
                    <option value="clientes">ğŸ‘¥ Clientes</option>
                    <option value="fornecedores">ğŸ“¦ Fornecedores</option>
                    <option value="processos">âš™ï¸ Processos</option>
                    <option value="outro">ğŸ“Œ Outro</option>
                </select>
            </div>
            <div class="form-group"><label>ConteÃºdo *</label><textarea id="conhConteudo" rows="4" placeholder="Ex: Frete SP-PR para madeira custa R$ 180/ton..."></textarea></div>
            <div class="form-group"><label>Tags (separe por vÃ­rgula)</label><input type="text" id="conhTags" placeholder="frete, sp, pr, madeira"></div>
            <button onclick="salvarConhecimento()" class="btn-success btn-full">ğŸ’¾ Salvar Conhecimento</button>
            <div id="alertaConh"></div>

            <h4 style="margin:25px 0 15px;color:#333;">ğŸ“– Conhecimentos Salvos (<span id="contConh">0</span>)</h4>
            <div class="search-box"><input type="text" id="buscaConh" placeholder="Buscar conhecimento..." oninput="filtrarConhecimentos()"></div>
            <div id="listaConh"></div>
        </div>
    </div>

    <!-- EXPORTAR -->
    <div id="exportar" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ’¾ Exportar / Backup</div>
            <div class="form-row">
                <button onclick="exportCSV()" class="btn-success btn-full">ğŸ“„ Contatos CSV</button>
                <button onclick="exportConhecimentos()" class="btn-success btn-full">ğŸ“š Conhecimentos CSV</button>
            </div>
            <button onclick="exportJSON()" class="btn-full">ğŸ“‹ Backup Completo JSON</button>
            <button onclick="exportWhatsApp()" class="btn-whatsapp btn-full">ğŸ“± Lista WhatsApp</button>

            <hr style="margin:25px 0;border:1px solid #eee;">
            <div class="form-group">
                <label>Restaurar Backup</label>
                <input type="file" id="fileRestore" accept=".json" onchange="restaurarBackup(event)" style="padding:10px;">
            </div>
            <hr style="margin:25px 0;border:1px solid #eee;">
            <button onclick="limparTudo()" class="btn-danger btn-full">ğŸ—‘ï¸ Limpar Banco</button>
        </div>
    </div>

    <!-- GOOGLE SHEETS -->
    <div id="sheets" class="tab-content">
        <div class="panel">
            <div class="section-title">ğŸ“Š IntegraÃ§Ã£o Google Sheets</div>

            <div class="alert info">
                ğŸ“‹ <strong>Configure a sincronizaÃ§Ã£o com Google Sheets</strong><br>
                Os contatos serÃ£o ADICIONADOS (nÃ£o substituÃ­dos) na planilha.
            </div>

            <div class="form-section">
                <h4>âš™ï¸ ConfiguraÃ§Ã£o</h4>
                <div class="form-group">
                    <label>ID da Planilha Google *</label>
                    <input type="text" id="sheetsId" placeholder="1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y">
                </div>
                <div class="form-group">
                    <label>URL do Web App (Google Apps Script) *</label>
                    <input type="text" id="sheetsWebApp" placeholder="https://script.google.com/macros/s/...">
                </div>
                <button onclick="salvarConfigSheets()" class="btn-success btn-full">ğŸ’¾ Salvar ConfiguraÃ§Ã£o</button>
            </div>

            <div class="form-section" style="margin-top:20px;">
                <h4>ğŸ”„ Sincronizar Contatos</h4>
                <p style="color:#666;margin-bottom:15px;">Enviar contatos do sistema para as abas da planilha Google Sheets.</p>

                <div class="form-row">
                    <button onclick="sincronizarSheets('motoristas')" class="btn-success btn-full">ğŸšš Enviar Motoristas</button>
                    <button onclick="sincronizarSheets('fornecedores')" class="btn-warning btn-full">ğŸ“¦ Enviar Fornecedores</button>
                    <button onclick="sincronizarSheets('clientes')" class="btn-full">ğŸ‘¥ Enviar Clientes</button>
                </div>
                <button onclick="sincronizarTodosSheets()" class="btn-whatsapp btn-full" style="margin-top:10px;">ğŸ”„ Sincronizar TODOS</button>

                <div id="sheetsStatus" style="margin-top:15px;"></div>
            </div>

            <div class="form-section" style="margin-top:20px;">
                <h4>ğŸ“¥ Importar da Planilha</h4>
                <p style="color:#666;margin-bottom:15px;">Buscar novos contatos das abas da planilha Google Sheets.</p>
                <button onclick="importarDeSheets()" class="btn-full">ğŸ“¥ Importar Novos Contatos</button>
            </div>

            <div class="alert warning" style="margin-top:20px;">
                âš ï¸ <strong>Importante:</strong> Configure o Google Apps Script com o cÃ³digo correto para que a sincronizaÃ§Ã£o funcione.
                A planilha deve ter as abas: <strong>Motoristas</strong>, <strong>Fornecedores</strong>, <strong>Clientes</strong>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== BANCO DE DADOS v6.12 ====================
let db = {
    motoristas: [],
    fornecedores: [],
    clientes: [],
    listas: [],
    tarefas: [],
    conhecimentos: [],
    whatsapp: {
        numeroVinculado: '5518996540492',
        nomeExibicao: 'Anderson Enside',
        conversas: [],
        mensagens: 0,
        chatsAnalisados: 0
    },
    agente: {
        nivel: 1,
        xp: 0,
        precisao: 50,
        interacoes: 0,
        imports: 0,
        historico: []
    },
    config: {
        versao: '6.15.0',
        planilhaId: '1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y',
        webAppUrl: 'https://script.google.com/macros/s/AKfycbzG4z5Jt3I35gYUc76eNdP7MMaSFJIfqjI2QjktcCVIu3saV_SJCgrpila9Zg0MaQ3V/exec',
        migrado: false
    }
};

let dadosPendentes = null;

// ==================== CARREGAR COM MIGRAÃ‡ÃƒO DE DADOS ANTIGOS ====================
function carregarDB() {
    try {
        const saved = localStorage.getItem('enside_db_v5');
        if (saved) {
            const p = JSON.parse(saved);
            console.log('ğŸ“¦ Dados encontrados:', p);

            // Migrar estrutura antiga para nova
            db.motoristas = p.motoristas || [];
            db.fornecedores = p.fornecedores || [];
            db.clientes = p.clientes || [];
            db.listas = p.listas || [];
            db.tarefas = p.tarefas || [];

            // âš ï¸ CRÃTICO: Preservar conhecimentos!
            if (p.conhecimentos && p.conhecimentos.length > 0) {
                db.conhecimentos = p.conhecimentos;
                console.log('âœ… Conhecimentos preservados:', db.conhecimentos.length);
                document.getElementById('alertaMigracao').style.display = 'block';
            }

            // Preservar WhatsApp
            if (p.whatsapp) {
                db.whatsapp = {
                    numeroVinculado: p.whatsapp.numeroVinculado || '5518996540492',
                    nomeExibicao: p.whatsapp.nomeExibicao || 'Anderson Enside',
                    conversas: p.whatsapp.conversas || [],
                    mensagens: p.whatsapp.mensagens || 0,
                    chatsAnalisados: p.whatsapp.chatsAnalisados || 0
                };
            }

            // Preservar Agente
            if (p.agente) {
                db.agente = {
                    nivel: p.agente.nivel || 1,
                    xp: p.agente.xp || 0,
                    precisao: p.agente.precisao || 50,
                    interacoes: p.agente.interacoes || 0,
                    imports: p.agente.imports || 0,
                    historico: p.agente.historico || []
                };
            }

            db.config.migrado = true;
        }

        console.log('âœ… DB v6.12 carregado:');
        console.log('   - Motoristas:', db.motoristas.length);
        console.log('   - Fornecedores:', db.fornecedores.length);
        console.log('   - Clientes:', db.clientes.length);
        console.log('   - Conhecimentos:', db.conhecimentos.length);
        console.log('   - WhatsApp:', db.whatsapp.numeroVinculado);

    } catch(e) {
        console.error('Erro ao carregar:', e);
    }
}

function salvarDB() {
    localStorage.setItem('enside_db_v5', JSON.stringify(db));
    atualizarTudo();
}

// ==================== ATUALIZAR INTERFACE ====================
function atualizarTudo() {
    const totalContatos = db.motoristas.length + db.fornecedores.length + db.clientes.length;
    const todosContatos = [...db.motoristas, ...db.fornecedores, ...db.clientes];
    const waTotal = todosContatos.filter(c => c.whatsapp).length;

    document.getElementById('sTotal').textContent = totalContatos;
    document.getElementById('sMot').textContent = db.motoristas.length;
    document.getElementById('sFor').textContent = db.fornecedores.length;
    document.getElementById('sCli').textContent = db.clientes.length;
    document.getElementById('sWa').textContent = waTotal;
    document.getElementById('sConh').textContent = db.conhecimentos.length;
    document.getElementById('badgeMot').textContent = totalContatos;
    document.getElementById('badgeConh').textContent = db.conhecimentos.length;

    // Tabela anÃ¡lise
    const motWa = db.motoristas.filter(m => m.whatsapp).length;
    const forWa = db.fornecedores.filter(f => f.whatsapp).length;
    const cliWa = db.clientes.filter(c => c.whatsapp).length;

    document.getElementById('tblAnalise').innerHTML =
        '<tr><td>ğŸšš Motoristas</td><td>'+db.motoristas.length+'</td><td>'+motWa+'</td><td>'+db.motoristas.filter(m=>m.nome&&m.whatsapp).length+'</td></tr>'+
        '<tr><td>ğŸ“¦ Fornecedores</td><td>'+db.fornecedores.length+'</td><td>'+forWa+'</td><td>'+db.fornecedores.filter(f=>f.nome&&f.whatsapp).length+'</td></tr>'+
        '<tr><td>ğŸ‘¥ Clientes</td><td>'+db.clientes.length+'</td><td>'+cliWa+'</td><td>'+db.clientes.filter(c=>c.nome&&c.whatsapp).length+'</td></tr>'+
        '<tr><td>ğŸ“š Conhecimentos</td><td colspan="3">'+db.conhecimentos.length+' itens na base</td></tr>'+
        '<tr style="font-weight:bold;background:#f5f5f5"><td>TOTAL</td><td>'+totalContatos+'</td><td>'+waTotal+'</td><td>-</td></tr>';

    // Agente IA
    const nivel = Math.floor(db.agente.xp / 100) + 1;
    db.agente.nivel = nivel;
    const aprend = Math.min(10 + db.conhecimentos.length * 5 + db.agente.interacoes * 2 + db.agente.imports * 3, 100);
    const nivelTxt = aprend < 20 ? 'Iniciante' : aprend < 40 ? 'Aprendiz' : aprend < 60 ? 'IntermediÃ¡rio' : aprend < 80 ? 'AvanÃ§ado' : 'Expert';

    // PrecisÃ£o baseada em conhecimentos
    db.agente.precisao = Math.min(50 + db.conhecimentos.length * 3 + db.agente.imports * 2, 98);

    document.getElementById('headerNivel').textContent = nivel;
    document.getElementById('dashNivel').textContent = nivel;
    document.getElementById('dashXP').textContent = db.agente.xp;
    document.getElementById('dashPrecisao').textContent = db.agente.precisao + '%';
    document.getElementById('dashConh').textContent = db.conhecimentos.length;
    document.getElementById('dashInteracoes').textContent = db.agente.interacoes;
    document.getElementById('dashConversas').textContent = db.whatsapp.conversas.length;
    document.getElementById('dashProgress').style.width = aprend + '%';
    document.getElementById('dashProgressText').textContent = aprend + '% - ' + nivelTxt;

    document.getElementById('agNivel').textContent = nivel;
    document.getElementById('agXP').textContent = db.agente.xp;
    document.getElementById('agPrecisao').textContent = db.agente.precisao + '%';
    document.getElementById('agConh').textContent = db.conhecimentos.length;
    document.getElementById('contConh').textContent = db.conhecimentos.length;

    // WhatsApp
    if (db.whatsapp.numeroVinculado) {
        const numFmt = formatarTelefone(db.whatsapp.numeroVinculado);
        document.getElementById('waVinculadoHeader').textContent = numFmt;
        document.getElementById('chatWaNum').textContent = numFmt;
        document.getElementById('waNumero').value = db.whatsapp.numeroVinculado;
        document.getElementById('waNome').value = db.whatsapp.nomeExibicao;
    }
    document.getElementById('waConv').textContent = db.whatsapp.conversas.length;
    document.getElementById('waMsgs').textContent = db.whatsapp.mensagens;
    document.getElementById('waAprend').textContent = db.whatsapp.chatsAnalisados;
}

function formatarTelefone(num) {
    if (!num) return '';
    const c = num.replace(/\D/g, '');
    if (c.length === 13) return '+' + c.slice(0,2) + ' (' + c.slice(2,4) + ') ' + c.slice(4,9) + '-' + c.slice(9);
    if (c.length === 11) return '(' + c.slice(0,2) + ') ' + c.slice(2,7) + '-' + c.slice(7);
    return num;
}

// ==================== SALVAR CONTATO ====================
function salvarContato() {
    const categoria = document.getElementById('cadCategoria').value;
    const nome = document.getElementById('cadNome').value.trim();
    const whatsapp = document.getElementById('cadWhatsapp').value.trim();

    if (!nome) { document.getElementById('alertaCad').innerHTML = '<div class="alert error">âŒ Nome obrigatÃ³rio!</div>'; return; }

    const contato = {
        id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        timestamp: new Date().toISOString(),
        nome: nome,
        whatsapp: whatsapp,
        rotasPreferidas: document.getElementById('cadRotas').value.split(',').map(r => r.trim()).filter(r => r),
        tipoProfissional: document.getElementById('cadTipoPro').value,
        tipoVeiculo: document.getElementById('cadTipoVeiculo').value,
        placa: document.getElementById('cadPlaca').value.trim(),
        capacidade: document.getElementById('cadCapacidade').value,
        tipoCarroceria: document.getElementById('cadCarroceria').value,
        regiaoSul: document.getElementById('cadSul').checked,
        regiaoSudeste: document.getElementById('cadSudeste').checked,
        regiaoCentroOeste: document.getElementById('cadCentroOeste').checked,
        regiaoNordeste: document.getElementById('cadNordeste').checked,
        regiaoNorte: document.getElementById('cadNorte').checked,
        cargaMadeira: document.getElementById('cadMadeira').checked,
        cargaCompensados: document.getElementById('cadCompensados').checked,
        cargaMDF: document.getElementById('cadMDF').checked,
        cargaMoveis: document.getElementById('cadMoveis').checked,
        cargaGeral: document.getElementById('cadGeral').checked,
        formaPagamento: document.getElementById('cadPagamento').value,
        pix: document.getElementById('cadPix').value.trim(),
        banco: document.getElementById('cadBanco').value.trim(),
        cpfCnpj: document.getElementById('cadCpfCnpj').value.trim(),
        antt: document.getElementById('cadAntt').value.trim(),
        categoria: categoria
    };

    db[categoria].push(contato);
    db.agente.xp += 15;
    salvarDB();

    // Limpar form
    document.querySelectorAll('#cadastrar input[type="text"], #cadastrar input[type="number"]').forEach(el => el.value = '');
    document.querySelectorAll('#cadastrar select:not(#cadCategoria)').forEach(el => el.selectedIndex = 0);
    document.querySelectorAll('#cadastrar input[type="checkbox"]').forEach(el => el.checked = false);

    document.getElementById('alertaCad').innerHTML = '<div class="alert success">âœ… Salvo com sucesso!</div>';
    addMsgAgente('âœ… Cadastrei ' + nome + ' em ' + categoria + '!');
}

// ==================== RENDER CONTATOS ====================
function filtrarMotoristas() {
    const busca = document.getElementById('buscaMot').value.toLowerCase();
    const tipo = document.getElementById('filtroTipo').value;
    const regiao = document.getElementById('filtroRegiao').value;

    let todos = [];
    if (!tipo || tipo === 'motoristas') todos = todos.concat(db.motoristas.map(m => ({...m, _tipo: 'motoristas'})));
    if (!tipo || tipo === 'fornecedores') todos = todos.concat(db.fornecedores.map(f => ({...f, _tipo: 'fornecedores'})));
    if (!tipo || tipo === 'clientes') todos = todos.concat(db.clientes.map(c => ({...c, _tipo: 'clientes'})));

    let filtrados = todos.filter(c => {
        if (busca && !c.nome.toLowerCase().includes(busca) && !(c.whatsapp || '').includes(busca)) return false;
        if (regiao) {
            const regiaoKey = 'regiao' + regiao.replace('-','');
            if (!c[regiaoKey] && !c['regiao' + regiao.charAt(0) + regiao.slice(1).toLowerCase()]) return false;
        }
        return true;
    });

    renderContatos(filtrados);
}

function renderContatos(arr) {
    const el = document.getElementById('listaMot');
    if (!arr.length) { el.innerHTML = '<div class="alert info">Nenhum contato encontrado</div>'; return; }

    el.innerHTML = arr.slice(0, 100).map(c => {
        const icone = c._tipo === 'motoristas' ? 'ğŸšš' : c._tipo === 'fornecedores' ? 'ğŸ“¦' : 'ğŸ‘¥';
        const badge = c._tipo === 'motoristas' ? 'badge-motorista' : c._tipo === 'fornecedores' ? 'badge-fornecedor' : 'badge-cliente';

        const regioes = [];
        if (c.regiaoSul) regioes.push('Sul');
        if (c.regiaoSudeste) regioes.push('Sudeste');
        if (c.regiaoCentroOeste) regioes.push('CO');
        if (c.regiaoNordeste) regioes.push('NE');
        if (c.regiaoNorte) regioes.push('Norte');

        return '<div class="card"><div class="card-header"><div class="card-title">' + icone + ' ' + c.nome + '</div><div>' +
            '<span class="card-badge ' + badge + '">' + c._tipo + '</span>' +
            (c.tipoVeiculo ? '<span class="card-badge badge-regiao">' + c.tipoVeiculo + '</span>' : '') +
            '</div></div>' +
            (c.whatsapp ? '<div class="card-field">ğŸ“± <a href="https://wa.me/55' + c.whatsapp.replace(/\D/g, '') + '" target="_blank">' + c.whatsapp + '</a></div>' : '') +
            (regioes.length ? '<div class="card-field">ğŸ—ºï¸ ' + regioes.join(', ') + '</div>' : '') +
            (c.estado ? '<div class="card-field">ğŸ“ ' + (c.cidade || '') + ' - ' + c.estado + '</div>' : '') +
            '<button onclick="excluirContato(\'' + c._tipo + '\',\'' + c.id + '\')" class="btn-small btn-danger" style="margin-top:8px;">ğŸ—‘ï¸</button></div>';
    }).join('');

    if (arr.length > 100) el.innerHTML += '<div class="alert info">Mostrando 100 de ' + arr.length + '</div>';
}

function excluirContato(tipo, id) {
    if (!confirm('Excluir?')) return;
    db[tipo] = db[tipo].filter(c => c.id !== id);
    salvarDB();
    filtrarMotoristas();
}

// ==================== IMPORTAR ====================
function importarArquivo(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        try {
            let dados = [];
            const ext = file.name.toLowerCase().split('.').pop();

            if (ext === 'json') {
                const parsed = JSON.parse(ev.target.result);
                if (parsed.motoristas || parsed.fornecedores || parsed.clientes || parsed.conhecimentos) {
                    if (confirm('Restaurar backup completo?\n\nMotoristas: ' + (parsed.motoristas?.length || 0) + '\nFornecedores: ' + (parsed.fornecedores?.length || 0) + '\nClientes: ' + (parsed.clientes?.length || 0) + '\nConhecimentos: ' + (parsed.conhecimentos?.length || 0))) {
                        Object.assign(db, parsed);
                        salvarDB();
                        document.getElementById('alertaImport').innerHTML = '<div class="alert success">âœ… Backup restaurado!</div>';
                        renderConhecimentos();
                    }
                    return;
                }
                dados = Array.isArray(parsed) ? parsed : [];
            } else {
                const lines = ev.target.result.trim().split('\n');
                const sep = lines[0].includes(';') ? ';' : lines[0].includes('\t') ? '\t' : ',';
                const headers = lines[0].split(sep).map(h => h.trim().replace(/"/g, ''));

                dados = lines.slice(1).map(line => {
                    const vals = line.split(sep).map(v => v.trim().replace(/^"|"$/g, ''));
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = vals[i] || '');
                    return obj;
                }).filter(r => r['Nome Completo'] || r.nome || r.Nome);
            }

            dadosPendentes = dados;
            document.getElementById('prevTotal').textContent = dados.length;
            document.getElementById('importPreview').style.display = 'block';
            document.getElementById('alertaImport').innerHTML = '<div class="alert info">ğŸ“Š ' + dados.length + ' registros prontos</div>';

        } catch(err) {
            document.getElementById('alertaImport').innerHTML = '<div class="alert error">âŒ Erro: ' + err.message + '</div>';
        }
    };
    reader.readAsText(file);
}

// ==================== TRIAGEM INTELIGENTE COM IA ====================
const PATTERNS_MOTORISTAS = [
    // Tipos de veÃ­culo
    /\b(truck|trucado|carreta|bitrem|rodotrem|toco|vuc|3\/4|bi.?trem)\b/i,
    /\b(ls|mercedes|volvo|scania|iveco|daf|man)\b/i,
    // ProfissÃ£o/FunÃ§Ã£o
    /\b(motorista|caminhoneiro|frete|freteiro|transportador|agregado|autÃ´nomo)\b/i,
    /\b(transporte|logist|entrega|coleta)\b/i,
    // Tipos de carga especÃ­ficos de transporte
    /\b(graneleiro|sider|carga|carroceria)\b/i
];

const PATTERNS_FORNECEDORES = [
    // IndÃºstria madeireira
    /\b(madeireira|serraria|serralheria|laminadora|compensado)\b/i,
    /\b(fabrica|fÃ¡brica|industria|indÃºstria|produt|manufat)\b/i,
    // Tipos de madeira
    /\b(pinus|eucalipto|pinho|cedro|mogno|mdf|osb|mdp|hdf)\b/i,
    // FunÃ§Ãµes de fornecimento
    /\b(fornece|distribui|atacad|revend|export)\b/i,
    // Locais especÃ­ficos
    /\b(deposito|depÃ³sito|armazÃ©m|armazem|estoque)\b/i
];

const PATTERNS_CLIENTES = [
    // Tipos de cliente
    /\b(moveis|mÃ³veis|marcenaria|carpintaria|construt|construÃ§)\b/i,
    /\b(obra|projeto|arquitet|design|decoraÃ§|loja)\b/i,
    // Comportamento de compra
    /\b(compra|cliente|consumidor|pedido|encomenda)\b/i
];

function classificarContato(nome, tags, fonte) {
    const texto = (nome + ' ' + (tags || '') + ' ' + (fonte || '')).toLowerCase();

    let scores = { motoristas: 0, fornecedores: 0, clientes: 0 };

    // Verificar padrÃµes de motorista
    PATTERNS_MOTORISTAS.forEach(p => {
        if (p.test(texto)) scores.motoristas += 10;
    });

    // Verificar padrÃµes de fornecedor
    PATTERNS_FORNECEDORES.forEach(p => {
        if (p.test(texto)) scores.fornecedores += 10;
    });

    // Verificar padrÃµes de cliente
    PATTERNS_CLIENTES.forEach(p => {
        if (p.test(texto)) scores.clientes += 10;
    });

    // Aprender com histÃ³rico do agente
    if (db.agente.historico && db.agente.historico.length > 0) {
        db.agente.historico.forEach(h => {
            if (texto.includes(h.palavra)) {
                scores[h.categoria] += 5;
            }
        });
    }

    // Determinar categoria com maior score
    let categoria = 'clientes';
    let maxScore = scores.clientes;

    if (scores.motoristas > maxScore) {
        categoria = 'motoristas';
        maxScore = scores.motoristas;
    }
    if (scores.fornecedores > maxScore) {
        categoria = 'fornecedores';
        maxScore = scores.fornecedores;
    }

    // Registrar aprendizado se score alto
    if (maxScore >= 10) {
        const palavras = texto.split(/\s+/).filter(p => p.length > 3);
        palavras.forEach(palavra => {
            const jaExiste = db.agente.historico?.some(h => h.palavra === palavra && h.categoria === categoria);
            if (!jaExiste && PATTERNS_MOTORISTAS.some(p => p.test(palavra)) ||
                PATTERNS_FORNECEDORES.some(p => p.test(palavra))) {
                if (!db.agente.historico) db.agente.historico = [];
                db.agente.historico.push({ palavra, categoria, count: 1 });
            }
        });
    }

    return { categoria, confianca: maxScore };
}

function confirmarImportacao() {
    if (!dadosPendentes) return;

    let count = 0;
    let stats = { motoristas: 0, fornecedores: 0, clientes: 0 };

    dadosPendentes.forEach(r => {
        // Suporte para mÃºltiplos formatos (incluindo Callbell)
        const nome = r['Nome Completo'] || r.nome || r.Nome || r.name || '';
        if (!nome) return;

        // Extrair telefone de diferentes formatos
        const telefone = r['WhatsApp'] || r.whatsapp || r.telefone ||
                        r.phone_number || r.phone || r['Telefone Corrigido'] || '';

        // Extrair tags (Callbell)
        const tags = r.tags || r.Tags || '';
        const fonte = r.source || r.origem || '';

        // Triagem inteligente com IA
        const { categoria, confianca } = classificarContato(nome, tags, fonte);

        const contato = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            timestamp: new Date().toISOString(),
            nome: nome,
            whatsapp: telefone.replace(/\D/g, ''),
            estado: r.estado || r.uf || r.Estado || '',
            cidade: r.cidade || r.Cidade || '',
            categoria: categoria,
            confianca: confianca,
            tags: tags,
            fonte: fonte,
            importadoEm: r.created_at || new Date().toISOString()
        };

        db[categoria].push(contato);
        stats[categoria]++;
        count++;
    });

    db.agente.xp += count;
    db.agente.imports++;
    salvarDB();

    document.getElementById('importPreview').style.display = 'none';
    document.getElementById('alertaImport').innerHTML =
        '<div class="alert success">âœ… ' + count + ' importados!<br>' +
        'ğŸšš ' + stats.motoristas + ' motoristas | ğŸ“¦ ' + stats.fornecedores + ' fornecedores | ğŸ‘¥ ' + stats.clientes + ' clientes</div>';
    dadosPendentes = null;
    document.getElementById('fileInput').value = '';

    addMsgAgente('ğŸ“¥ Importei ' + count + ' contatos com triagem inteligente!<br>' +
                 'ğŸšš ' + stats.motoristas + ' motoristas<br>' +
                 'ğŸ“¦ ' + stats.fornecedores + ' fornecedores<br>' +
                 'ğŸ‘¥ ' + stats.clientes + ' clientes');
}

function cancelarImportacao() {
    dadosPendentes = null;
    document.getElementById('importPreview').style.display = 'none';
}

// ==================== LISTAS ====================
function criarLista() {
    const nome = document.getElementById('listaNome').value.trim();
    if (!nome) return;

    const tipo = document.getElementById('listaFiltroTipo').value;
    const regiao = document.getElementById('listaFiltroRegiao').value;

    let contatos = [];
    if (!tipo || tipo === 'motoristas') contatos = contatos.concat(db.motoristas.filter(m => m.whatsapp));
    if (!tipo || tipo === 'fornecedores') contatos = contatos.concat(db.fornecedores.filter(f => f.whatsapp));
    if (!tipo || tipo === 'clientes') contatos = contatos.concat(db.clientes.filter(c => c.whatsapp));

    if (regiao) {
        contatos = contatos.filter(c => {
            const regiaoKey = 'regiao' + regiao.replace('-','');
            return c[regiaoKey];
        });
    }

    if (!contatos.length) { alert('Nenhum contato!'); return; }

    const chunks = [];
    for (let i = 0; i < contatos.length; i += 256) chunks.push(contatos.slice(i, i + 256));

    chunks.forEach((chunk, idx) => {
        db.listas.push({
            id: Date.now() + '-' + idx,
            nome: chunks.length > 1 ? nome + ' (' + (idx+1) + '/' + chunks.length + ')' : nome,
            contatos: chunk.map(c => ({ id: c.id, nome: c.nome, whatsapp: c.whatsapp })),
            total: chunk.length,
            criado: new Date().toLocaleDateString('pt-BR')
        });
    });

    db.agente.xp += 20;
    salvarDB();
    document.getElementById('listaNome').value = '';
    renderListas();
    addMsgAgente('ğŸ“‹ Criei ' + chunks.length + ' lista(s) com ' + contatos.length + ' contatos!');
}

function renderListas() {
    const el = document.getElementById('minhasListas');
    if (!db.listas.length) { el.innerHTML = '<div class="alert info">Nenhuma lista</div>'; return; }

    el.innerHTML = db.listas.map(l => '<div class="list-item"><div class="list-info"><h4>ğŸ“‹ ' + l.nome + '</h4><p>' + l.criado + '</p></div><div style="display:flex;gap:10px;align-items:center;"><span class="list-count">' + l.total + '</span><button onclick="exportarLista(\'' + l.id + '\')" class="btn-small btn-whatsapp">ğŸ“±</button><button onclick="excluirLista(\'' + l.id + '\')" class="btn-small btn-danger">ğŸ—‘ï¸</button></div></div>').join('');
}

function exportarLista(id) {
    const l = db.listas.find(x => x.id === id);
    if (!l) return;
    let csv = 'Nome,WhatsApp\n';
    l.contatos.forEach(c => csv += '"' + c.nome + '","' + c.whatsapp + '"\n');
    download(csv, 'lista_' + l.nome.replace(/[^a-zA-Z0-9]/g, '_') + '.csv');
}

function excluirLista(id) {
    if (!confirm('Excluir?')) return;
    db.listas = db.listas.filter(l => l.id !== id);
    salvarDB();
    renderListas();
}

// ==================== CONHECIMENTOS ====================
function salvarConhecimento() {
    const titulo = document.getElementById('conhTitulo').value.trim();
    const conteudo = document.getElementById('conhConteudo').value.trim();

    if (!titulo || !conteudo) {
        document.getElementById('alertaConh').innerHTML = '<div class="alert error">âŒ TÃ­tulo e conteÃºdo obrigatÃ³rios!</div>';
        return;
    }

    db.conhecimentos.push({
        id: Date.now(),
        titulo: titulo,
        categoria: document.getElementById('conhCat').value,
        conteudo: conteudo,
        tags: document.getElementById('conhTags').value.split(',').map(t => t.trim()).filter(t => t),
        criado: new Date().toLocaleDateString('pt-BR')
    });

    db.agente.xp += 15;
    salvarDB();

    document.getElementById('conhTitulo').value = '';
    document.getElementById('conhConteudo').value = '';
    document.getElementById('conhTags').value = '';
    document.getElementById('alertaConh').innerHTML = '<div class="alert success">âœ… Conhecimento salvo! O agente vai usar isso!</div>';
    renderConhecimentos();
    addMsgAgente('ğŸ“š Aprendi sobre "' + titulo + '"! Agora posso usar essa informaÃ§Ã£o.');
}

function filtrarConhecimentos() {
    const busca = document.getElementById('buscaConh').value.toLowerCase();
    const filtrados = db.conhecimentos.filter(c =>
        c.titulo.toLowerCase().includes(busca) ||
        c.conteudo.toLowerCase().includes(busca) ||
        c.tags?.some(t => t.toLowerCase().includes(busca))
    );
    renderConhecimentos(filtrados);
}

function renderConhecimentos(arr) {
    const lista = arr || db.conhecimentos;
    const el = document.getElementById('listaConh');

    if (!lista.length) {
        el.innerHTML = '<div class="alert info">Nenhum conhecimento. Ensine o agente!</div>';
        return;
    }

    el.innerHTML = lista.map(c =>
        '<div class="knowledge-card">' +
        '<span class="categoria">' + (c.categoria || 'outro') + '</span>' +
        '<h4>ğŸ“– ' + c.titulo + '</h4>' +
        '<p>' + c.conteudo + '</p>' +
        (c.tags && c.tags.length ? '<div class="knowledge-tags">' + c.tags.map(t => '<span class="knowledge-tag">' + t + '</span>').join('') + '</div>' : '') +
        '<div style="margin-top:10px;font-size:0.8em;color:#999;">Criado: ' + (c.criado || 'N/A') + '</div>' +
        '<button onclick="excluirConhecimento(' + c.id + ')" class="btn-small btn-danger" style="margin-top:10px;">ğŸ—‘ï¸</button>' +
        '</div>'
    ).join('');
}

function excluirConhecimento(id) {
    if (!confirm('Excluir conhecimento?')) return;
    db.conhecimentos = db.conhecimentos.filter(c => c.id !== id);
    salvarDB();
    renderConhecimentos();
}

// ==================== WHATSAPP ====================
function salvarWhatsApp() {
    const numero = document.getElementById('waNumero').value.replace(/\D/g, '');
    const nome = document.getElementById('waNome').value.trim();

    db.whatsapp.numeroVinculado = numero;
    db.whatsapp.nomeExibicao = nome || 'Anderson Enside';
    db.agente.xp += 10;
    salvarDB();

    addMsgAgente('ğŸ“± WhatsApp atualizado: ' + formatarTelefone(numero));
}

function simularConversa() {
    const nomes = ['JoÃ£o Madeireira', 'Maria ConstruÃ§Ãµes', 'Carlos Frete', 'Pedro MÃ³veis', 'Ana Pinus'];
    const msgs = ['Tem frete SP-PR?', 'Qual preÃ§o pinus?', 'Preciso de caminhÃ£o', 'Entrega quando?', 'Faz MDF?'];

    const conv = {
        id: Date.now(),
        contato: nomes[Math.floor(Math.random() * nomes.length)],
        telefone: '5518' + Math.random().toString().slice(2, 11),
        msg: msgs[Math.floor(Math.random() * msgs.length)],
        hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
        data: new Date().toLocaleDateString('pt-BR')
    };

    db.whatsapp.conversas.push(conv);
    db.whatsapp.mensagens++;
    db.whatsapp.chatsAnalisados++;
    db.agente.xp += 5;
    salvarDB();

    renderConversas();

    // Agente tenta responder usando conhecimentos
    const resposta = buscarRespostaConhecimento(conv.msg);
    addMsgAgente('ğŸ“± ' + conv.contato + ': "' + conv.msg + '"<br><br>ğŸ’¡ ' + resposta);
}

function buscarRespostaConhecimento(pergunta) {
    const pl = pergunta.toLowerCase();

    // Buscar nos conhecimentos
    for (const c of db.conhecimentos) {
        if (c.titulo.toLowerCase().includes(pl.split(' ')[0]) ||
            c.tags?.some(t => pl.includes(t.toLowerCase())) ||
            c.conteudo.toLowerCase().includes(pl.split(' ')[0])) {
            return 'ğŸ“š Encontrei: ' + c.titulo + '<br>' + c.conteudo.slice(0, 150) + '...';
        }
    }

    return 'NÃ£o tenho essa informaÃ§Ã£o ainda. Adicione na aba ğŸ“š Conhecimentos!';
}

function renderConversas() {
    const el = document.getElementById('waConversas');
    if (!db.whatsapp.conversas.length) {
        el.innerHTML = '<div class="alert info">Nenhuma conversa. Clique em "Simular" para testar!</div>';
        return;
    }

    el.innerHTML = db.whatsapp.conversas.slice(-10).reverse().map(c =>
        '<div class="wa-conversation">' +
        '<div class="header"><span class="contato">ğŸ‘¤ ' + c.contato + '</span><span class="hora">' + c.hora + '</span></div>' +
        '<div class="msg">' + c.msg + '</div>' +
        '</div>'
    ).join('');
}

// ==================== AGENTE IA CHAT ====================
function enviarMsg() {
    const input = document.getElementById('chatIn');
    const msg = input.value.trim();
    if (!msg) return;

    document.getElementById('chatMsgs').innerHTML += '<div class="chat-msg user">' + msg + '<div class="time">' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    input.value = '';

    db.agente.interacoes++;
    db.agente.xp += 2;

    document.getElementById('agTyping').style.display = 'inline';

    setTimeout(() => {
        document.getElementById('agTyping').style.display = 'none';
        addMsgAgente(processarPergunta(msg));
        salvarDB();
    }, 600);
}

function processarPergunta(msg) {
    const ml = msg.toLowerCase();

    // âš ï¸ BUSCA NOS CONHECIMENTOS PRIMEIRO!
    for (const c of db.conhecimentos) {
        const tituloL = c.titulo.toLowerCase();
        const conteudoL = c.conteudo.toLowerCase();
        const tagsL = (c.tags || []).map(t => t.toLowerCase());

        // Verifica se alguma palavra da pergunta estÃ¡ no conhecimento
        const palavras = ml.split(/\s+/).filter(p => p.length > 2);
        for (const palavra of palavras) {
            if (tituloL.includes(palavra) || tagsL.some(t => t.includes(palavra)) || conteudoL.includes(palavra)) {
                return 'ğŸ“š <strong>' + c.titulo + '</strong><br><br>' + c.conteudo;
            }
        }
    }

    // Respostas padrÃ£o
    if (ml.includes('resumo') || ml.includes('status') || ml.includes('quanto')) {
        const total = db.motoristas.length + db.fornecedores.length + db.clientes.length;
        return 'ğŸ“Š <strong>Resumo v6.15:</strong><br><br>' +
               'ğŸšš ' + db.motoristas.length + ' motoristas<br>' +
               'ğŸ“¦ ' + db.fornecedores.length + ' fornecedores<br>' +
               'ğŸ‘¥ ' + db.clientes.length + ' clientes<br>' +
               'ğŸ“š ' + db.conhecimentos.length + ' conhecimentos<br>' +
               'ğŸ“± ' + db.whatsapp.conversas.length + ' conversas';
    }

    if (ml.includes('motorista')) return 'ğŸšš Tenho ' + db.motoristas.length + ' motoristas cadastrados!';
    if (ml.includes('fornecedor')) return 'ğŸ“¦ Tenho ' + db.fornecedores.length + ' fornecedores!';
    if (ml.includes('cliente')) return 'ğŸ‘¥ Tenho ' + db.clientes.length + ' clientes!';
    if (ml.includes('conhecimento') || ml.includes('aprend')) return 'ğŸ“š Tenho ' + db.conhecimentos.length + ' conhecimentos na base!';

    if (ml.includes('ajuda') || ml.includes('comandos')) {
        return 'ğŸ’¡ <strong>Posso ajudar com:</strong><br><br>' +
               'â€¢ Status/resumo dos dados<br>' +
               'â€¢ InformaÃ§Ãµes sobre motoristas, fornecedores, clientes<br>' +
               'â€¢ Buscar nos conhecimentos que vocÃª me ensinou<br><br>' +
               'ğŸ“š Adicione conhecimentos na aba "Conhecimentos" para eu aprender!';
    }

    return 'ğŸ¤” NÃ£o encontrei essa informaÃ§Ã£o na minha base de conhecimento.<br><br>ğŸ’¡ <strong>Dica:</strong> Adicione esse conhecimento na aba ğŸ“š Conhecimentos para eu aprender!';
}

function addMsgAgente(msg) {
    const el = document.getElementById('chatMsgs');
    el.innerHTML += '<div class="chat-msg agent">' + msg + '<div class="time">' + new Date().toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    el.scrollTop = el.scrollHeight;
}

// ==================== EXPORTAR ====================
function exportCSV() {
    const todos = [...db.motoristas, ...db.fornecedores, ...db.clientes];
    if (!todos.length) { alert('Nenhum contato!'); return; }
    let csv = 'Nome,WhatsApp,Categoria,Estado\n';
    todos.forEach(c => csv += '"' + (c.nome||'') + '","' + (c.whatsapp||'') + '","' + (c.categoria||'') + '","' + (c.estado||'') + '"\n');
    download(csv, 'contatos_enside.csv');
}

function exportConhecimentos() {
    if (!db.conhecimentos.length) { alert('Nenhum conhecimento!'); return; }
    let csv = 'Titulo,Categoria,Conteudo,Tags,Criado\n';
    db.conhecimentos.forEach(c => csv += '"' + c.titulo + '","' + (c.categoria||'') + '","' + c.conteudo.replace(/"/g, '""') + '","' + (c.tags||[]).join(';') + '","' + (c.criado||'') + '"\n');
    download(csv, 'conhecimentos_enside.csv');
}

function exportJSON() {
    download(JSON.stringify(db, null, 2), 'enside_backup_v6.12_' + new Date().toISOString().slice(0,10) + '.json');
}

function exportWhatsApp() {
    const todos = [...db.motoristas, ...db.fornecedores, ...db.clientes].filter(c => c.whatsapp);
    if (!todos.length) { alert('Nenhum WhatsApp!'); return; }
    let csv = 'Nome,WhatsApp\n';
    todos.forEach(c => csv += '"' + c.nome + '","' + c.whatsapp + '"\n');
    download(csv, 'whatsapp_contatos.csv');
}

function download(content, filename) {
    const a = document.createElement('a');
    a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
    a.download = filename;
    a.click();
}

function restaurarBackup(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            if (confirm('Restaurar backup?\n\nMotoristas: ' + (data.motoristas?.length || 0) + '\nFornecedores: ' + (data.fornecedores?.length || 0) + '\nClientes: ' + (data.clientes?.length || 0) + '\nConhecimentos: ' + (data.conhecimentos?.length || 0))) {
                Object.assign(db, data);
                salvarDB();
                renderConhecimentos();
                alert('âœ… Restaurado!');
            }
        } catch(err) { alert('âŒ Erro!'); }
    };
    reader.readAsText(file);
}

function limparTudo() {
    if (!confirm('âš ï¸ APAGAR TUDO?')) return;
    if (!confirm('ğŸš¨ CERTEZA? Seus conhecimentos serÃ£o perdidos!')) return;
    localStorage.removeItem('enside_db_v5');
    location.reload();
}

// ==================== NAVEGAÃ‡ÃƒO ====================
function abrirAba(id, btn) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (btn) btn.classList.add('active');

    if (id === 'motoristas') filtrarMotoristas();
    if (id === 'listas') renderListas();
    if (id === 'aprendizado') renderConhecimentos();
    if (id === 'whatsapp') renderConversas();
}

function abrirInner(id, btn) {
    const parent = btn.closest('.panel');
    parent.querySelectorAll('.inner-content').forEach(el => el.classList.remove('active'));
    parent.querySelectorAll('.inner-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

// ==================== INICIALIZAÃ‡ÃƒO ====================
carregarDB();
atualizarTudo();
filtrarMotoristas();
renderListas();
renderConhecimentos();
renderConversas();

setTimeout(() => {
    let msg = 'ğŸ‘‹ OlÃ¡ Anderson! <strong>Enside Agent v6.15 ULTRA COMPLETO</strong><br><br>';
    msg += 'ğŸ“± WhatsApp: ' + formatarTelefone(db.whatsapp.numeroVinculado) + '<br>';
    msg += 'ğŸšš ' + db.motoristas.length + ' motoristas | ğŸ“¦ ' + db.fornecedores.length + ' fornecedores | ğŸ‘¥ ' + db.clientes.length + ' clientes<br>';
    msg += 'ğŸ“š <strong>' + db.conhecimentos.length + ' conhecimentos</strong> na base<br><br>';

    if (db.conhecimentos.length > 0) {
        msg += 'âœ… Seus conhecimentos foram preservados! Eu uso eles para responder.<br>';
    } else {
        msg += 'ğŸ’¡ Adicione conhecimentos na aba ğŸ“š para eu aprender!<br>';
    }

    addMsgAgente(msg);
}, 500);

// ==================== GOOGLE SHEETS INTEGRATION ====================
function carregarConfigSheets() {
    // Carregar configuraÃ§Ãµes salvas
    if (db.config.planilhaId) {
        document.getElementById('sheetsId').value = db.config.planilhaId;
    }
    if (db.config.webAppUrl) {
        document.getElementById('sheetsWebApp').value = db.config.webAppUrl;
    }
}

function salvarConfigSheets() {
    const planilhaId = document.getElementById('sheetsId').value.trim();
    const webAppUrl = document.getElementById('sheetsWebApp').value.trim();

    if (!planilhaId || !webAppUrl) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert error">âŒ Preencha o ID da planilha e a URL do Web App!</div>';
        return;
    }

    db.config.planilhaId = planilhaId;
    db.config.webAppUrl = webAppUrl;
    salvarDB();

    document.getElementById('sheetsStatus').innerHTML =
        '<div class="alert success">âœ… ConfiguraÃ§Ã£o salva com sucesso!</div>';

    addMsgAgente('ğŸ“Š ConfiguraÃ§Ã£o do Google Sheets salva!<br>Planilha: ' + planilhaId.slice(0, 15) + '...');
}

async function sincronizarSheets(tipo) {
    const webAppUrl = db.config.webAppUrl;
    if (!webAppUrl) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert error">âŒ Configure a URL do Web App primeiro!</div>';
        return;
    }

    const contatos = db[tipo] || [];
    if (!contatos.length) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert warning">âš ï¸ Nenhum ' + tipo.slice(0, -1) + ' para sincronizar!</div>';
        return;
    }

    document.getElementById('sheetsStatus').innerHTML =
        '<div class="alert info">ğŸ”„ Sincronizando ' + contatos.length + ' ' + tipo + '...</div>';

    // Preparar dados para enviar
    const dados = contatos.map(c => ({
        nome: c.nome || '',
        whatsapp: c.whatsapp || '',
        estado: c.estado || '',
        cidade: c.cidade || '',
        categoria: tipo,
        tags: c.tags || '',
        data: c.timestamp || c.importadoEm || new Date().toISOString()
    }));

    try {
        const response = await fetch(webAppUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'append',
                aba: tipo.charAt(0).toUpperCase() + tipo.slice(1),
                dados: dados
            })
        });

        // Como estamos usando no-cors, nÃ£o temos acesso Ã  resposta
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert success">âœ… ' + contatos.length + ' ' + tipo + ' enviados para Google Sheets!<br>' +
            '<small>Verifique a planilha para confirmar.</small></div>';

        db.agente.xp += 10;
        salvarDB();

        addMsgAgente('ğŸ“Š Sincronizei ' + contatos.length + ' ' + tipo + ' com Google Sheets!');

    } catch (error) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert error">âŒ Erro ao sincronizar: ' + error.message + '</div>';
        console.error('Erro sync:', error);
    }
}

async function sincronizarTodosSheets() {
    document.getElementById('sheetsStatus').innerHTML =
        '<div class="alert info">ğŸ”„ Sincronizando todos os contatos...</div>';

    await sincronizarSheets('motoristas');
    await new Promise(r => setTimeout(r, 1000));
    await sincronizarSheets('fornecedores');
    await new Promise(r => setTimeout(r, 1000));
    await sincronizarSheets('clientes');

    document.getElementById('sheetsStatus').innerHTML =
        '<div class="alert success">âœ… Todos os contatos foram enviados para Google Sheets!</div>';
}

async function importarDeSheets() {
    const webAppUrl = db.config.webAppUrl;
    if (!webAppUrl) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert error">âŒ Configure a URL do Web App primeiro!</div>';
        return;
    }

    document.getElementById('sheetsStatus').innerHTML =
        '<div class="alert info">ğŸ“¥ Buscando contatos da planilha...</div>';

    try {
        // Fazer request GET para buscar dados
        const response = await fetch(webAppUrl + '?action=get', {
            method: 'GET'
        });

        if (response.ok) {
            const data = await response.json();

            if (data.motoristas) {
                data.motoristas.forEach(c => {
                    if (c.nome && !db.motoristas.some(m => m.whatsapp === c.whatsapp)) {
                        db.motoristas.push({
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            ...c,
                            categoria: 'motoristas'
                        });
                    }
                });
            }

            if (data.fornecedores) {
                data.fornecedores.forEach(c => {
                    if (c.nome && !db.fornecedores.some(f => f.whatsapp === c.whatsapp)) {
                        db.fornecedores.push({
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            ...c,
                            categoria: 'fornecedores'
                        });
                    }
                });
            }

            if (data.clientes) {
                data.clientes.forEach(c => {
                    if (c.nome && !db.clientes.some(cl => cl.whatsapp === c.whatsapp)) {
                        db.clientes.push({
                            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                            ...c,
                            categoria: 'clientes'
                        });
                    }
                });
            }

            salvarDB();
            document.getElementById('sheetsStatus').innerHTML =
                '<div class="alert success">âœ… ImportaÃ§Ã£o concluÃ­da! Verifique a aba Motoristas.</div>';

            addMsgAgente('ğŸ“¥ Importei novos contatos do Google Sheets!');
        } else {
            throw new Error('Resposta invÃ¡lida do servidor');
        }

    } catch (error) {
        document.getElementById('sheetsStatus').innerHTML =
            '<div class="alert warning">âš ï¸ NÃ£o foi possÃ­vel importar automaticamente.<br>' +
            'Use a funÃ§Ã£o de importar arquivo CSV exportado da planilha.</div>';
        console.error('Erro import:', error);
    }
}

// Carregar config do Sheets ao iniciar
setTimeout(carregarConfigSheets, 100);

console.log('âœ… ENSIDE v6.15 ULTRA COMPLETO - TRIAGEM IA + GOOGLE SHEETS - PRONTO!');
console.log('ğŸ“š Conhecimentos carregados:', db.conhecimentos.length);
console.log('ğŸ“Š Google Sheets configurado:', db.config.planilhaId ? 'Sim' : 'NÃ£o');
</script>
</body>
</html>